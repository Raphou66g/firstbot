<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>

<body>
    <style>
        #map {
            border: 1px red solid;
        }
    </style>

    <script>
        const canvas_size = 700;

        let context = null;
        let key_down = false;

        const packet_types = {
            LEFT: 'left',
            RIGHT: 'right',
            FORWARD: 'forward',
            BACKWARD: 'backward',
            STOP: 'stop',
            ODOMETRY: 'odometry'
        }

        const colors = {
            RED: { red: 255, green: 0, blue: 0 },
            GREEN: { red: 0, green: 255, blue: 0 },
            BLUE: { red: 0, green: 0, blue: 255 },
        }

        function set_pixel(x, y, { red, green, blue }) {
            context.fillStyle = `rgba(${red},${green},${blue}, 1)`;
            context.fillRect(x, y, 5, 5);
        }

        function keypress_handler(socket, event) {
            if (key_down) {
                return;
            }

            let packet_type = null;

            switch (event.key) {
                case "w":
                    packet_type = packet_types.FORWARD;
                    break;
                case "a":
                    packet_type = packet_types.LEFT;
                    break;
                case "d":
                    packet_type = packet_types.RIGHT;
                    break;
                case "s":
                    packet_type = packet_types.BACKWARD;
                    break;
                default:
                    return;
            }

            key_down = true;

            socket.send(JSON.stringify({
                type: packet_type
            }));
        }

        function keyup_handler(socket, event) {
            key_down = false;

            socket.send(JSON.stringify({
                type: packet_types.STOP
            }));
        }

        function handle_odometry_packet(message) {

            function point_to_centered(x, y) {
                return {
                    centered_x: x + canvas_size / 2,
                    centered_y: y + canvas_size / 2
                };
            }

            const { x, y, theta } = message.data;
            const { centered_x, centered_y } = point_to_centered(x, y);

            set_pixel(centered_x, centered_y, colors.RED);
        }

        const socket = new WebSocket("ws://localhost:8080")
        socket.addEventListener("open", (event) => {
            const canvas = document.createElement("canvas");
            canvas.width = canvas_size;
            canvas.height = canvas_size;
            canvas.id = "map";

            context = canvas.getContext("2d");
            document.body.appendChild(canvas);

            document.addEventListener('keypress', event => keypress_handler(socket, event));
            document.addEventListener('keyup', event => keyup_handler(socket, event));
        });


        // Listen for messages
        socket.addEventListener("message", (event) => {
            const message = JSON.parse(event.data);

            switch (message.type) {
                case packet_types.ODOMETRY:
                    handle_odometry_packet(message);
                    break;
                default:
                    break;
            }
        });
    </script>
</body>

</html>